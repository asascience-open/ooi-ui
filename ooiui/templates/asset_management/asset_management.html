{% extends "common/base.html" %}

{% block title %}
  <title>Asset Management</title>
{% endblock %}

{% block beforebootstrap %}

{% endblock %}

{% block head %}
  <link href="/css/compiled/index.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" type="text/css" href="/css/common/assets.css">
  <link rel="stylesheet" type="text/css" href="/css/common/assetEditorModal.css">
  <link href="/css/compiled/asset_management.css" rel="stylesheet" type="text/css"/>


  <script src="/js/partials/compiled/index.js" type="text/javascript"></script>
  <script src="/js/partials/compiled/asset_management.js" type="text/javascript"></script>
  <script src="/js/compiled/index.js" type="text/javascript"></script>
  <script src="/js/views/asset_management/AssetView.js" type="text/javascript"></script>
  <script src="/js/views/asset_management/AssetEventsView.js" type="text/javascript"></script>
  <script src="/js/models/asset_management/AssetModel.js" type="text/javascript"></script>
  <script src="/js/models/asset_management/AssetEventsModel.js" type="text/javascript"></script>
  <script src="/js/models/asset_management/AlfrescoDocumentModel.js" type="text/javascript"></script>
  <script src="/js/views/asset_management/AlfrescoDocumentView.js" type="text/javascript"></script>
  <script src="/js/core/common/paginate.js" type="text/javascript"></script>
  <script src="/js/compiled/data_catalog.js" type="text/javascript"></script>
  <script type="text/javascript">
    $.jgrid.no_legacy_api = true;
    $.jgrid.useJSON = true;
  </script>

  {% block link %}
    {{ super() }}
  {% endblock %}
  {% block script %}
    {{ super() }}
  {% endblock %}
  <style>
    #search-param: { display: none; }
  </style>
{% endblock %}

{% block body %}
  <div class="container-fluid">
    <div id="navbar" class="row"></div>
  </div>

  <div id="wrapper" style="padding-left: 0">
    <div id="page-content-wrapper">
      <div class="container-fluid">
        <div id="page-content">
          <div class="row">
            <div class="col-md-12" id="loadingSpinner" style="width:100%;">
              <span id="" style="margin-left:50%; font-size:18px;">
                <b>Loading table...</b><i class="fa fa-spinner fa-spin fa-4x"></i>
              </span>
            </div>
            <div class="col-md-12" id="rowButtons" hidden>
              <div style="width:100%;">
                <span style='margin-left:0px;font-weight:600;font-size:16px'>Quick Table Actions</span>
              </div>
              <div id="dcGroupings">
                <button type='button' title='Reset Table Filters' style='float:left;margin-bottom:15px;' id='dcScienceFilter' class='btn btn-primary btn-xs' onclick='setScienceFilter("","");'><i style='font-size:14px;float:left;pointer-events: none;'>Reset Table</i></button>
                <a target="_blank" href="/api/asset_deployment?export=json" id="assetExportBtn" class="btn btn-primary btn-xs" style="float:left;margin-bottom: 15px;margin-left: 5px;">Export Asset Information (JSON)</a>
                <button type='button' title='Show Deployed' style='float:left;margin-bottom: 15px;margin-left: 5px;' id='dcScienceFilter' class='btn btn-primary btn-xs' onclick='setScienceFilter("tense","PRESENT");'><i style='font-size:14px;float:left;pointer-events: none;'>Show Deployed</i></button>
                <button type='button' title='Show Recovered' style='float:left;margin-bottom: 15px;margin-left: 5px;' id='dcScienceFilter' class='btn btn-primary btn-xs' onclick='setScienceFilter("tense","PAST");'><i style='font-size:14px;float:left;pointer-events: none;'>Show Recovered</i></button>
                {#                <div class="toggle-btn-grp cssonly">#}
                {#                  <div><input type="radio" name="group4"/><label onclick="" class="toggle-btn">Valid Assets</label></div>#}
                {#                  <div><input type="radio" name="group4"/><label onclick="" class="toggle-btn">Invalid Assets</label></div>#}
                {#                </div>#}
                {#                <div class="toggle-btn-grp cssonly">#}
                {#                  <div><input title="Deployed" type="radio" name="group9"/><label onclick='setScienceFilter("tense", "PRESENT");' class="toggle-btn">Deployed</label></div>#}
                {#                  <div><input title="Not Deployed" type="radio" name="group9"/><label onclick='setScienceFilter("tense","PAST");' class="toggle-btn">Not Deployed</label></div>#}
                {#                </div>#}
              </div>
            </div>
            <div class="col-md-12">
              <!-- jqGrid Assets-->
              <div>
                <div id="navGrid" class="redmond"></div>
                <table id="grid" class="redmond"></table>
              </div>
            </div>
          </div> <!-- row -->
          <div class="row" id="rowFilters" hidden>
            <div class="col-md-4" style='margin-top:10px;'>
              <div style="width:100%;">
                <span style='margin-left:0px;font-weight:600;font-size:16px;'>Metadata Filters</span>
              </div>
            </div>
            <div class="col-md-8" style='margin-top:10px;'>
              <div style="width:100%;">
                <span style='margin-left:0px;font-weight:600;font-size:16px;'>Event Table Filters</span>
              </div>
              <div>
                <button type='button' title='Show All Events' style='float:left;margin-bottom: 15px;margin-left: 5px;' id='dcEventFilter' class='btn btn-primary btn-xs' onclick='setEventFilter("","");'><i style='font-size:14px;float:left;pointer-events: none;'>All</i></button>
                <button type='button' title='Show Deployment Events' style='float:left;margin-bottom: 15px;margin-left: 5px;' id='dcEventFilter' class='btn btn-primary btn-xs' onclick='setEventFilter("eventClass",".DeploymentEvent");'><i style='font-size:14px;float:left;pointer-events: none;'>Deployment</i></button>
                <button type='button' title='Show Integration Events' style='float:left;margin-bottom: 15px;margin-left: 5px;' id='dcEventFilter' class='btn btn-primary btn-xs' onclick='setEventFilter("eventClass",".IntegrationEvent");'><i style='font-size:14px;float:left;pointer-events: none;'>Integration</i></button>
                <button type='button' title='Show Calibration Events' style='float:left;margin-bottom: 15px;margin-left: 5px;' id='dcEventFilter' class='btn btn-primary btn-xs' onclick='setEventFilter("eventClass",".CalibrationEvent");'><i style='font-size:14px;float:left;pointer-events: none;'>Calibration</i></button>
                <button type='button' title='Show Tag Events' style='float:left;margin-bottom: 15px;margin-left: 5px;' id='dcEventFilter' class='btn btn-primary btn-xs' onclick='setEventFilter("eventClass",".TagEvent");'><i style='font-size:14px;float:left;pointer-events: none;'>Tag</i></button>
              </div>
            </div>
          </div><!-- subgrids filters row -->
          <div class="row" id="rowSubGrids" hidden>
            <div class="col-md-4">
              <!-- jqGrid Metadata-->
              <div>
                <div id="navGridMetadata" class="redmond"></div>
                <table id="gridMetadata" class="redmond"></table>
              </div>
            </div>
            <div class="col-md-8">
              <!-- jqGrid Events-->
              <div>
                <div id="navGridEvents" class="redmond"></div>
                <table id="gridEvents" class="redmond"></table>
              </div>
            </div>
          </div><!-- subgrids row -->
          <div class="row" id="rowAlfresco" hidden>
            <div style="width:100%;">
              <hr>
              <span style='margin-left:15px;font-weight:600;font-size:16px;'>Alfresco Documents</span>
            </div>
            <div class="col-md-12">
              <div role="tabpanel" class="tab-pane" id="remoteDocuments">
                <table class="table table-striped" id="">
                  <thead>
                  <tr>
                    <th id="remoteDocDownload">Download</th>
                    <th>Document</th>
                    <th>Type</th>
                  </tr>
                  </thead>
                  <tbody id="loadDocs">
                  <tr><td colspan="2"><span id="" style="text-decoration:underline; cursor:pointer;">
                            <b>Click a record above to refresh...</b><i class="fa fa-spinner fa-spin" style="margin-left:50%; font-size:12px;"></i>
                        </span></td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div><!-- pagge-content -->
      </div><!-- .container-fluid -->
    </div><!-- #page-content-wrapper -->
  </div><!-- #wrapper -->

  <!-- Menu Toggle Script -->
  <script type="text/javascript">

    var bannerTitle = "Asset Management";

    _.extend(OOI.prototype, Backbone.Events, {
      login: new LoginModel(),
      views: {
        headerView: null
      },
      models: {
        userModel: new UserModel()
      },
      start: function() {
        this.login.fetch({async:false});

        banner = new BannerView({bannerTitle: bannerTitle});

        navbar = new NavbarView({
          login: this.login
        });

        this.views.banner = new BannerView({bannerTitle : bannerTitle});
        $('body').prepend(this.views.banner.el);

        this.views.navbar = new NavbarView({
          el: $('#navbar')
        });

        this.views.navbar = new NavbarView();
        $('body').prepend(this.views.navbar.el);

        //checks and adds streaming title
        if (this.views.banner.checkStreaming()){
            $('.container-fluid.banner-image').addClass('news-active')
        }

        {#        footer = new AssetTabelFooterView({});#}
        {##}
        {#        //Render the asset table header#}
        {#        this.views.headerView = renderAssetTableHeader();#}
        {##}
        {#        updateCollection( showAssets );#}
        {##}
        {#        this.listenTo(collection, "collection:updated", function(details){#}
        {#          vent.trigger('asset:tableDerender');#}
        {#          updatePagination(details, showAssets);#}
        {#        });#}
        {##}
        {#        this.listenTo(vent, 'asset:changeCollection', function() {#}
        {#          vent.trigger('asset:tableDerender');#}
        {#          updateCollection( showAssets );#}
        {#        });#}
        {##}
        {#        this.listenTo(vent, "asset:renderSubViews", function(model) {#}
        {#          vent.trigger('asset:derender');#}
        {#          renderAssetInspector(model);#}
        {#          renderAssetEventsTable(model);#}
        {#        });#}
        {##}
        this.listenTo(vent, "asset:renderDocsTable", function(model) {
          renderRemoteDocuments(model);
        });

        this.listenTo(this, "login:success", this.onLogin);
        this.listenTo(this, "login:logout", this.onLogout);
        // TOC Controls
        this.listenTo(this, 'toc:selectArray', function(model) {
          {#          var searchFor = model.get('array_name').substr(0,14);#}
          {#          $('#search').val(searchFor);#}
          {#          $('#search-clear').show();#}
          {#          updateCollection( showAssets );#}
        });
        this.listenTo(this, 'toc:selectPlatform', function(model) {
          {#          var searchFor = model.get('ref_des').substr(0,8);#}
          {#          $('#search').val(searchFor);#}
          {#          $('#search-clear').show();#}
          {#          updateCollection( showAssets );#}
        });

        this.listenTo(this, 'toc:selectInstrument', function(model) {
          {#          var searchFor = model.get('ref_des');#}
          {#          $('#search').val(searchFor);#}
          {#          $('#search-clear').show();#}
          {#          updateCollection( showAssets );#}
        });
        this.listenTo(this, 'toc:selectAssembly', function(model) {
          {#          var searchFor = model.get('ref_des').substr(0,11);#}
          {#          $('#search').val(searchFor);#}
          {#          $('#search-clear').show();#}
          {#          updateCollection( showAssets );#}
        });
      }
    });

    var vent = _.extend({}, Backbone.Events);

    // Main collection for this page's asset information.
    var collection          = new AssetCollection();
    var assetCollection     = new AssetCollection();
    var arrayCollection     = new ArrayCollection();
    var streamCollection    = new StreamCollection();

    var ooi = new OOI();

    // url arguments
    var data = { min : 'True' };
    // begin the iterative fetching of arrays, assets, and streams.
    var arrayFetch = arrayCollection.fetch({ reset: true });
    var assetFetch = assetCollection.fetch({ data: data, reset: true });
    var streamFetch = streamCollection.fetch({ data: data,  reset: true });
    {#    $.when(arrayFetch, assetFetch, streamFetch).done(function() {#}
    {#      $.when( (renderTOCView( arrayCollection, assetCollection, streamCollection )) ).done(function() {#}
    {#        $('#search-param').remove();#}
    {#        $('.detached').remove();#}
    {#        vent.trigger('toc:cleanUp');#}
    {#        vent.trigger('toc:hideStreams');#}
    {#        $('#menu-toggle').trigger('click');#}
    {#        focusToItem();#}
    {#      });#}
    {#    });#}

    // Page Controls
    {#    var pageControlModel = new AssetManagementPageControlModel();#}
    {#    var pageControlView = new AssetManagementPageControlView({model: pageControlModel, el: $('#buttons')});#}
    {#    pageControlView.render();#}
    {##}
    {#    var pagination = {#}
    {#      itemsPerPage: 10,#}
    {#      currentPage: 1,#}
    {#      maxPages: 10#}
    {#    };#}

    // Sets up the action buttons in the jqGrid table
    var createActionButtons = function(cellvalue, options, rowObject){
      {#      console.log(rowObject);#}
      var actionButtons = "<div style='display: flex;justify-content: space-between;'>";
      actionButtons += "<button type='button' title='Plot' style='float:left' id='goPlot' class='btn btn-default' onclick=\"openPlot('"+rowObject.ref_des+"');\"><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-bar-chart' aria-hidden='true'></i></button>";
      {#      actionButtons += "<button type='button' title='Download' style='float:right' id='goDownload' class='btn btn-default' onclick=\"openDownload('"+rowObject.ref_des+"');\"><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-download' aria-hidden='true'></i></button>";#}
      actionButtons += "<button type='button' title='Data Catalog' style='float:left' id='goDataCatalog' class='btn btn-default' onclick=\"openDataCatalog('"+rowObject.ref_des+"');\"><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-database' aria-hidden='true'></i></button>";
      actionButtons += "</div>";
      return actionButtons;
    };

    // Opens the plotting page
    var openPlot = function(ref_des){
      location.origin = location.protocol + "//" + location.host;
      var win = window.open(location.origin+"/plot/#"+ref_des, '_blank');
      win.focus();
    };

    // Opens the download modal
    var openDownload = function(ref_des) {
      var dlModel = collection.where({ref_des:ref_des})[0];
      dlModel.attributes.email = ooi.models.userModel.attributes.email;
      ooi.trigger('StreamTableItemView:onClick', {model: dlModel});
    };

    var openDataCatalog = function(ref_des) {
      location.origin = location.protocol + "//" + location.host;
      var win = window.open(location.origin+"/datacatalog/#"+ref_des, '_blank');
      win.focus();
    };

    var getEditUrl = function() {
      {#      console.log(lastsel2);#}
      location.origin = location.protocol + "//" + location.host;
      return location.origin+"/api/asset_deployment/"+lastsel2;
    };

    // Colors the end time
    var colorTime = function(cellvalue, options, rowObject) {
      var currentDate = new Date();
      var endDate = new Date(cellvalue);
      var timeSinceEndDate = currentDate.getTime()-endDate.getTime();

      // Base cell output is no background
      var cellOutput = '<i>'+cellvalue+'</i>';
      if(timeSinceEndDate <= 1000*60*60*12 && timeSinceEndDate >= 0){
        cellOutput = '<i class="twelve-hours">'+cellvalue+'</i>';
      } else if(timeSinceEndDate < 1000*60*60*24 && timeSinceEndDate >= 0){
        cellOutput = '<i class="twenty-four-hours">'+cellvalue+'</i>';
      } else if(timeSinceEndDate >= 1000*60*60*24 && timeSinceEndDate >= 0){
        cellOutput = '<i class="older">'+cellvalue+'</i>';
      }
      return cellOutput;
    };

    $(document).ready(function() {
      $(".delayImg").each(function() {
        this.onload = function() {
          $(this).animate({opacity: 1}, 2000);
        };
        this.src = this.getAttribute("delayedSrc");
      });
      ooi.start();

      populate();
    });

    var setScienceFilter = function(searchColumn, searchParam){
      {#      console.log(event);#}
      var searchFiler = searchParam, grid = $("#grid"), f;
      if (searchFiler.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      f.rules.push({field:searchColumn,op:"cn",data:searchFiler});
      grid[0].p.search = true;
      $.extend(grid[0].p.postData,{filters:JSON.stringify(f)});
      grid.trigger("reloadGrid",[{page:1,current:true}]);
    };

    var setNavFilter = function(searchColumn, searchParam){
      var searchFiler = searchParam.split(" "), grid = $("#grid"), f;
      if (searchFiler.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      $.each (searchFiler, function() {
        f.rules.push({field:searchColumn,op:"bw",data:this});
      });
      grid[0].p.search = true;
      $.extend(grid[0].p.postData,{filters:JSON.stringify(f)});
      grid.trigger("reloadGrid",[{page:1,current:true}]);
    };

    var setEventFilter = function(searchColumn, searchParam){
      {#      console.log(event);#}
      var searchFiler = searchParam, grid = $("#gridEvents"), f;
      if (searchFiler.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      f.rules.push({field:searchColumn,op:"cn",data:searchFiler});
      grid[0].p.search = true;
      $.extend(grid[0].p.postData,{filters:JSON.stringify(f)});
      grid.trigger("reloadGrid",[{page:1,current:true}]);
    };

    var numberTemplate = {
      formatter : 'number',
      align : 'right',
      sorttype : 'number',
      editable : true,
      searchoptions : { sopt : ['eq', 'ne', 'lt', 'le', 'gt', 'ge', 'nu', 'nn', 'in', 'ni'] }
    };

    var defaultFilters = {
      "groupOp" : "AND",
      "rules" : [
        { "field" : "All", "op" : "cn", "data" : ""}
      ]
    };

    var $dcGrid = $("#grid");
    var $gridMetadata = $("#gridMetadata");
    var $gridEvents = $("#gridEvents");
    var lastsel2;

    var getUniqueNames = function(columnName) {
        var texts = $dcGrid[0].p.data, uniqueTexts = [],
          textsLength = texts.length, text, textsMap = {}, i;
        for (i=0;i<textsLength;i++) {
          text = texts[i][columnName];
          if (text !== undefined && textsMap[text] === undefined) {
            // to test whether the texts is unique we place it in the map.
            textsMap[text] = true;
            uniqueTexts.push(text);
          }
        }
        {#        console.log(uniqueTexts);#}
        return uniqueTexts;
      },
      buildSearchSelect = function(uniqueNames) {
        var values=":All";
        $.each (uniqueNames, function() {
          values += ";" + this + ":" + this;
        });
        return values;
      },
      setSearchSelect = function(columnName) {
        $dcGrid.jqGrid('setColProp', columnName,
          {
            stype: 'select',
            searchoptions: {
              value:buildSearchSelect(getUniqueNames(columnName)),
              sopt:['eq']
            }
          }
        );
      };

    //define handler for 'editSubmit' event
    var fn_editSubmit=function(response,postdata){
      {#      console.log('fn_editSubmit');#}
      {#      console.log(response);#}
      {#      console.log(postdata);#}
      var json=response.responseText; //in my case response text form server is "{sc:true,msg:''}"
      var result=eval("("+json+")"); //create js object from server reponse
      {#      console.log(result);#}
      return [result,null];
    };

    //define edit options for navgrid
    var editOptions={
      {#      top: 50, left: "100", width: 500,#}
      closeOnEscape: true, afterSubmit: fn_editSubmit
    };

    function exportData(e, id){

      var gridid 		= jQuery(id).getDataIDs(); // Get all the ids in array
      var label 		= jQuery(id).getRowData(gridid[0]); // Get First row to get the labels
      var selRowIds 	= jQuery(id).jqGrid ('getGridParam', 'selarrrow');

      var obj 		= new Object();
      obj.count		= selRowIds.length;

      if(obj.count) {

        obj.items		= new Array();

        for(elem in selRowIds) {
          obj.items.push(jQuery(id).getRowData( selRowIds[elem] ));
        }

        var json = JSON.stringify(obj);

        JSONToCSVConverter(json, "csv", 1);
      }
    }

    function JSONToCSVConverter(JSONData, ReportTitle, ShowLabel) {

      //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
      var arrData = typeof JSONData != 'object' ? JSON.parse(JSONData) : JSONData;
      var CSV = '';
      //This condition will generate the Label/Header
      if (ShowLabel) {
        var row = "";

        //This loop will extract the label from 1st index of on array
        for (var index in arrData.items[0]) {
          //Now convert each value to string and comma-seprated
          row += index + ',';
        }
        row = row.slice(0, -1);
        //append Label row with line break
        CSV += row + '\r\n';
      }

      //1st loop is to extract each row
      for (var i = 0; i < arrData.items.length; i++) {
        var row = "";
        //2nd loop will extract each column and convert it in string comma-seprated
        for (var index in arrData.items[i]) {
          row += '"' + arrData.items[i][index].replace(/(<([^>]+)>)/ig, '') + '",';
        }
        row.slice(0, row.length - 1);
        //add a line break after each row
        CSV += row + '\r\n';
      }

      if (CSV == '') {
        alert("Invalid data");
        return;
      }

      //this trick will generate a temp "a" tag
      var link = document.createElement("a");
      link.id="lnkDwnldLnk";

      //this part will append the anchor tag and remove it after automatic click
      document.body.appendChild(link);

      var csv = CSV;
      blob = new Blob([csv], { type: 'text/csv' });

      var myURL = window.URL || window.webkitURL;

      var csvUrl = myURL.createObjectURL(blob);
      var filename = 'UserExport.csv';
      jQuery("#lnkDwnldLnk")
        .attr({
          'download': filename,
          'href': csvUrl
        });

      jQuery('#lnkDwnldLnk')[0].click();
      document.body.removeChild(link);

    }

    var highlightFilteredData = function () {
      var $self = $(this), filters, i, l, rules, rule, iCol,
        isFiltered = $self.jqGrid("getGridParam", "search"),
        postData = $self.jqGrid("getGridParam", "postData"),
        colModel = $self.jqGrid("getGridParam", "colModel"),
        colIndexByName = {};

      // validate whether we have input for highlighting
      if (!isFiltered || typeof postData !== "object") {
        return;
      }
      filters = $.parseJSON(postData.filters);
      if (filters == null || filters.rules == null || filters.rules.length <= 0) {
        return;
      }

      // fill colIndexByName which get easy column index by the column name
      for (i = 0, l = colModel.length; i < l; i++) {
        colIndexByName[colModel[i].name] = i;
      }

      rules = filters.rules;
      for (i = 0, l = rules.length; i < l; i++) {
        rule = rules[i];
        iCol = colIndexByName[rule.field];
        if (iCol !== undefined) {
          $self.find(">tbody>tr.jqgrow>td:nth-child(" + (iCol + 1) + ")").highlight(rule.data);
        }
      }
    };

    var showRows = function() {
      $("#loadingSpinner").hide();
      $("#rowButtons").show();
      $("#rowFilters").show();
      $("#rowSubGrids").show();
      $("#rowAlfresco").show();
    };

    var currentAssetId;

    // Loads the jqGrid into
    function placeJqGrid(collection) {
      {#      console.log(collection);#}
      $dcGrid.jqGrid({
        datatype : "local",
        data : collection.toJSON(),
        editurl : "/api/asset_deployment/ajax",
        colNames: [
          'Actions',
          'Asset ID',
          'Array',
          'Assembly',
          'Description',
          'Instrument Class',
          'Long Name',
          'Name',
          'Owner',
          'Type',
          'Coordinates',
          'Data Source',
          'Deployment Number',
          'Manufacturer',
          'Model Number',
          'Serial Number',
          'Depth Rating (m)',
          'Height (cm)',
          'Length (cm)',
          'Required Power (Watts)',
          'Weight (Oz)',
          'Width (cm)',
          'Delivery Date',
          'Purchase Cost',
          'Purchase Date',
          'Tense',
          'Reference Designator',
          'Last Modified'
        ],

        colModel : [
          { name : 'actions',
            caption : 'Plot/Download',
            width : 80,
            sortable : false,
            search : false,
            align : 'center',
            formatter : createActionButtons
          },
          {
            name : 'id',
            index : 'id',
            key : true, // rowID = unique_id = ref_des+stream_name
            hidden : false,
            editable : false,
            width : 100,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align: 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'assetInfo.array',
            index : 'assetInfo.array',
            editable : false,
            width : 150,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'assetInfo.assembly',
            index : 'assetInfo.assembly',
            editable : false,
            {#                      width : 100,#}
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'assetInfo.description',
            index : 'assetInfo.description',
            editable : false,
            width : 290,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'assetInfo.instrumentClass',
            index : 'assetInfo.instrumentClass',
            editable : false,
            {#                      width : 100,#}
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'assetInfo.longName',
            index : 'assetInfo.longName',
            editable : false,
            {#                      width : 100,#}
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'assetInfo.name',
            index : 'assetInfo.name',
            editable : false,
            {#                      width : 100,#}
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'assetInfo.owner',
            index : 'assetInfo.owner',
            editable : false,
            {#                      width : 100,#}
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'assetInfo.type',
            index : 'assetInfo.type',
            editable : false,
            {#                      width : 100,#}
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'coordinates',
            index : 'coordinates',
            editable : false,
            {#                      width : 100,#}
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'assetInfo.dataSource',
            index : 'assetInfo.dataSource',
            editable : false,
            {#                      width : 100,#}
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'deployment_number',
            index : 'deployment_number',
            editable : false,
            width : 140,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'manufactureInfo.manufacturer',
            index : 'manufactureInfo.manufacturer',
            editable : false,
            width : 150,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'manufactureInfo.modelNumber',
            index : 'manufactureInfo.modelNumber',
            editable : false,
            width : 150,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'manufactureInfo.serialNumber',
            index : 'manufactureInfo.serialNumber',
            editable : false,
            width : 150,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'physicalInfo.depthRatingM',
            index : 'physicalInfo.depthRatingM',
            hidden : false,
            editable : false,
            {#            width : 165,#}
            hidden : true,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align: 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'physicalInfo.heightCm',
            index : 'physicalInfo.heightCm',
            hidden : false,
            editable : false,
            {#            width : 165,#}
            hidden : true,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align: 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'physicalInfo.lengthCm',
            index : 'physicalInfo.lengthCm',
            hidden : false,
            editable : false,
            {#            width : 165,#}
            hidden : true,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align: 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'physicalInfo.requiredPowerW',
            index : 'physicalInfo.requiredPowerW',
            editable : false,
            {#            width : 165,#}
            hidden : true,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align: 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'physicalInfo.weightOz',
            index : 'physicalInfo.weightOz',
            editable : false,
            {#            width : 165,#}
            hidden : true,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align: 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'physicalInfo.widthCm',
            index : 'physicalInfo.widthCm',
            editable : false,
            {#            width : 165,#}
            hidden : true,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align: 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'purchaseAndDeliveryInfo.deliveryDate',
            index : 'purchaseAndDeliveryInfo.deliveryDate',
            editable : false,
            {#                width : 85,#}
            hidden : true,
            sortable : true,
            sorttype : 'date',
            formatter: unixTimeToDateTime,
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'purchaseAndDeliveryInfo.purchaseCost',
            index : 'purchaseAndDeliveryInfo.purchaseCost',
            editable : false,
            {#                width : 85,#}
            hidden : true,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'purchaseAndDeliveryInfo.purchaseDate',
            index : 'purchaseAndDeliveryInfo.purchaseDate',
            editable : false,
            {#                width : 85,#}
            hidden : true,
            sortable : true,
            sorttype : 'date',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name: 'tense',
            index: 'tense',
            key: false, // rowID = reference_designator
            editable: false,
            width: 75,
            sortable: true,
            sorttype: 'string',
            searchoptions: {sopt: ['cn', 'eq', 'ne', 'lt', 'le', 'gt', 'ge', 'bw', 'bn', 'in', 'ni', 'ew', 'en', 'nc']},
            align: 'center',
            unformat: function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name: 'ref_des',
            index: 'ref_des',
            key: false, // rowID = reference_designator
            editable: false,
            width: 240,
            sortable: true,
            sorttype: 'string',
            searchoptions: {sopt: ['cn', 'eq', 'ne', 'lt', 'le', 'gt', 'ge', 'bw', 'bn', 'in', 'ni', 'ew', 'en', 'nc']},
            align: 'center',
            unformat: function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'lastModifiedTimestamp',
            index : 'lastModifiedTimestamp',
            hidden : false,
            editable : false,
            width : 350,
            sortable : true,
            sorttype : 'date',
            formatter: unixTimeToDateTime,
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align: 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          }
        ],
        {#        ondblClickRow: function (id) { alert("You double click row with id: " + id); },#}
        loadComplete : function() {
          $("#navGrid").find("option[value=\"50000\"]").text('All');
          highlightFilteredData.call(this);
          showRows();
        },
        onSelectRow: function (rowId, status, e) {
          $gridMetadata.jqGrid("clearGridData");
          $gridEvents.jqGrid("clearGridData");
{#          console.log('currentAssetId');#}
{#          console.log($dcGrid.getRowData(rowId));#}
          currentAssetId = $dcGrid.getRowData(rowId).id;
{#          console.log(currentAssetId);#}
          {#          console.log(collection.where({id:parseInt(rowId)})[0]);#}
          setEventFilter("","");
          $gridMetadata.jqGrid('resetSelection');
          $gridEvents.jqGrid('resetSelection');
          var metadataObjects = collection.where({id:parseInt(rowId)})[0].attributes.metaData;
          $gridMetadata.setGridParam({data:metadataObjects});
          $gridMetadata.trigger("reloadGrid",[{page:1,current:true}]);

          var eventObjects = collection.where({id:parseInt(rowId)})[0].attributes.events;
          $gridEvents.setGridParam({data:eventObjects});
          $gridEvents.trigger("reloadGrid",[{page:1,current:true}]);

          renderRemoteDocuments(collection.where({id:parseInt(rowId)})[0]);
        },
        {#        onSelectRow: function(id){#}
        {#          if(id && id!==lastsel2){#}
        {#            $dcGrid.restoreRow(lastsel2);#}
        {#            $dcGrid.editRow(id,true);#}
        {#            lastsel2=id;#}
        {#          }#}
        {#        },#}
        {#        ajaxRowOptions : {#}
        {#          type :"POST",#}
        {#          contentType :"application/json; charset=utf-8",#}
        {#          dataType :"json"#}
        {#        },#}
        {#        serializeRowData: function(postdata){#}
        {#          console.log(postdata);#}
        {#          return JSON.stringify(postdata);#}
        {#        },#}
        gridview : true,
        toolbar: [true, "top"],
        rowNum : 10,
        rowList : [10, 20, 30, 40, 50000],
        autowidth : true,
        height : 'auto',
        pager : '#navGrid',
        sortname : 'end',
        autoencode: true,
        viewrecords : true,
        sortorder : 'desc',
        caption : 'Asset Management',
        altRows: false,
        {#        altclass:'myAltRowClass',#}
        {#        classes: 'table table-bordered table-striped table-selectable',#}
        ignoreCase: true,
        shrinkToFit : false,
        multiselect: true,
        multiboxonly: true,
        reloadAfterSubmit : false,
        loadOnce : false
      }).jqGrid('navGrid',
        '#navGrid',
        {add:false, view:false, del:false,edit:false,pdf:true,search:true}
        {#        ,{closeOnEscape: true, afterSubmit: fn_editSubmit}#}
        {#        ,{closeOnEscape: true, afterSubmit: fn_editSubmit} /*add options*/#}
        ,{} /*delete options*/
        ,{multipleSearch:true}
        ,{closeOnEscape:true}
        {#        {#}
        {#          edit : true,#}
        {#          add : true,#}
        {#          del : false,#}
        {##}
        {#          // beforeRefresh:#}
        {#          // Set the latest data from collection before refreshing grid#}
        {#            beforeRefresh : function () {#}
        {#              $("#grid").jqGrid('setGridParam', {#}
        {#                datatype : 'local',#}
        {#                data : ooi.collections.streams.toJSON()#}
        {#              });#}
        {#            }#}
        {#        },#}
        {#        {serializeEditData: function (postdata) {return JSON.stringify(postdata)}},#}
        {#        {serializeEditData: function (postdata) {return JSON.stringify(postdata)}},#}
        {#        {},#}
        {#        {#}
        {#          cloneToTop : true,#}
        {#          closeOnEscape : true,#}
        {#          multipleSearch : true,#}
        {#          overlay: 0,#}
        {#          onInitializeSearch: function ($form) {#}
        {#            $form.jqFilter('addFilter', defaultFilters);#}
        {#          },#}
        {#          afterRedraw: function (p) {#}
        {#            if (p.columns.length === $("#grid")[0].p.colModel.length) {#}
        {#              p.columns.push({#}
        {#                name: 'All',#}
        {#                label: 'Any Field',#}
        {#                searchoptions: {},#}
        {#                searchrules: {},#}
        {#                searchtype: 'string',#}
        {#                inputtype: 'text'#}
        {#              });#}
        {#            }#}
        {#            //$(this).find('.delete-rule:first').hide();#}
        {#          }#}
        {#        }#}
      );

      // CSV Export footer button
      $dcGrid.jqGrid('navButtonAdd','#navGrid',{
        id:'ExportToExcel',
        caption:'Export Selected Rows To CSV',
        title:'Export Selected Rows To CSV',
        onClickButton : function(e)
        {
          exportData(e, '#grid');
        },
        buttonicon: 'ui-icon ui-icon-document'
      });

      // Column mover and chooser
      $dcGrid.jqGrid('navButtonAdd', '#navGrid', {
        caption: "showcolumns",
        buttonicon: "ui-icon-calculator",
        title: "Choose columns",
        onClickButton: function () {
          $(this).jqGrid('columnChooser',{
            {#						width: 700,#}
            {#						dialog_opts: {#}
            {#							modal: true,#}
            {#							minWidth: 470,#}
            {#							height: 470,#}
            {#							show: 'blind',#}
            {#							hide: 'explode',#}
            {#							dividerLocation: 0.5#}
            {#						}#}
          });
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.selected")
            .bind("sortreceive", function (event, ui) {
              alert('column "' + ui.item.text() + '" is chosen');
            });
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.available a.action")
            .click(function () {
              alert('column "' + $(this).parent().text() + '" is chosen');
            });

        }
      });


      {#      setSearchSelect('assetInfo.array');#}
      {#      $dcGrid.jqGrid('setColProp', 'assetInfo.array',#}
      {#        {#}
      {#          searchoptions: {#}
      {#            sopt:['cn'],#}
      {#            dataInit: function(elem) {#}
      {#              $(elem).autocomplete({#}
      {#                source:getUniqueNames('assetInfo.array'),#}
      {#                delay:0,#}
      {#                minLength:0#}
      {#              });#}
      {#            }#}
      {#          }#}
      {#        }#}
      {#      );#}

      $dcGrid.jqGrid('filterToolbar',
        {
          autosearch : true,
          searchOperators : false,
          searchOnEnter : false,
          stringResult : true,
          defaultSearch : "cn"
        }
      );

      if(location.hash!=""){
        setScienceFilter('ref_des', location.hash.split('#')[1]);
      }

      // fill top toolbar
      var $grid = $dcGrid;
      $('#t_' + $.jgrid.jqID($grid[0].id))
        .append($("<div><label for=\"globalSearchText\">Global search in grid for:&nbsp;</label><input id=\"globalSearchText\" type=\"text\"></input>&nbsp;<button id=\"globalSearch\" type=\"button\">Search</button></div>"));
      $("#globalSearchText").keypress(function (e) {
        var key = e.charCode || e.keyCode || 0;
        if (key === $.ui.keyCode.ENTER) { // 13
          $("#globalSearch").click();
        }
      });
      $("#globalSearch").button({
        icons: { primary: "ui-icon-search" },
        text: false
      }).click(function () {
        var postData = $grid.jqGrid("getGridParam", "postData"),
          colModel = $grid.jqGrid("getGridParam", "colModel"),
          rules = [],
          searchText = $("#globalSearchText").val(),
          l = colModel.length,
          searchTextParts = $.trim(searchText).match(/"([^"]+)"|'([^']+)'|\S+/g), //.split(separator),
          cnParts = searchTextParts === null ? 0 : searchTextParts.length,
          i,
          iPart,
          token,
          cm;

        // normalize searchTextParts by removing quotes
        for (iPart = 0; iPart < cnParts; iPart++) {
          token = searchTextParts[iPart];
          if (token.length > 2 &&
            ((token[0] === '"' && token[token.length - 1] === '"') ||
            (token[0] === "'" && token[token.length - 1] === "'"))) {
            searchTextParts[iPart] = token.substr(1,token.length-2);
          }
        }

        for (i = 0; i < l; i++) {
          cm = colModel[i];
          if (cm.search !== false && (cm.stype === undefined || cm.stype === "text")) {
            for (iPart = 0; iPart < cnParts; iPart++) {
              rules.push({
                field: cm.name,
                op: "cn",
                data: searchTextParts[iPart]
              });
            }
          }
        }
        postData.filters = JSON.stringify({
          groupOp: "AND",
          rules: rules
        });
        $grid.jqGrid("setGridParam", { search: true });
        $grid.trigger("reloadGrid", [{page: 1, current: true}]);
        return false;
      });

    } // placeJqGrid

    function placeJqGridMetadata(collection) {
      {#      console.log(collection);#}
      $gridMetadata.jqGrid({
        datatype : "local",
        data : collection,
        editurl : "/api/asset_deployment/ajax",
        colNames: [
          'Key',
          'Type',
          'Value'
        ],

        colModel : [
          {
            name : 'key',
            index : 'key',
            editable : false,
            {#                      width : 100,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'type',
            index : 'type',
            editable : false,
            hidden : true,
            {#                      width : 100,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'value',
            index : 'value',
            editable : false,
            {#                      width : 100,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          }
        ],
        {#        ondblClickRow: function (id) { alert("You double click row with id: " + id); },#}
        loadComplete : function(data) {
          $("#navGridMetadata").find("option[value=\"50000\"]").text('All');
        },
        {#        onSelectRow: function(id){#}
        {#          if(id && id!==lastsel2){#}
        {#            $dcGrid.restoreRow(lastsel2);#}
        {#            $dcGrid.editRow(id,true);#}
        {#            lastsel2=id;#}
        {#          }#}
        {#        },#}
        {#        ajaxRowOptions : {#}
        {#          type :"POST",#}
        {#          contentType :"application/json; charset=utf-8",#}
        {#          dataType :"json"#}
        {#        },#}
        serializeRowData: function(postdata){
          {#          console.log(postdata);#}
          return JSON.stringify(postdata);
        },
        gridview : true,
        rowNum : 15,
        rowList : [15, 30, 45, 60, 50000],
        autowidth : true,
        height : 'auto',
        pager : '#navGridMetadata',
        sortname : 'end',
        viewrecords : true,
        sortorder : 'desc',
        caption : 'Metadata',
        altRows: false,
        {#        altclass:'myAltRowClass',#}
        {#        classes: 'table table-bordered table-striped table-selectable',#}
        ignoreCase: true,
        shrinkToFit : false,
        multiselect: true,
        multiboxonly: true,
        reloadAfterSubmit : false,
        loadOnce : false
      }).jqGrid('navGrid',
        '#navGridMetadata',
        {add:false, view:false, del:false,edit:false,pdf:true}
        ,{closeOnEscape: true, afterSubmit: fn_editSubmit}
        ,{closeOnEscape: true, afterSubmit: fn_editSubmit} /*add options*/
        ,{} /*delete options*/
        ,{multipleSearch:true}
        ,{closeOnEscape:true}
        {#        {#}
        {#          edit : true,#}
        {#          add : true,#}
        {#          del : false,#}
        {##}
        {#          // beforeRefresh:#}
        {#          // Set the latest data from collection before refreshing grid#}
        {#            beforeRefresh : function () {#}
        {#              $("#grid").jqGrid('setGridParam', {#}
        {#                datatype : 'local',#}
        {#                data : ooi.collections.streams.toJSON()#}
        {#              });#}
        {#            }#}
        {#        },#}
        {#        {serializeEditData: function (postdata) {return JSON.stringify(postdata)}},#}
        {#        {serializeEditData: function (postdata) {return JSON.stringify(postdata)}},#}
        {#        {},#}
        {#        {#}
        {#          cloneToTop : true,#}
        {#          closeOnEscape : true,#}
        {#          multipleSearch : true,#}
        {#          overlay: 0,#}
        {#          onInitializeSearch: function ($form) {#}
        {#            $form.jqFilter('addFilter', defaultFilters);#}
        {#          },#}
        {#          afterRedraw: function (p) {#}
        {#            if (p.columns.length === $("#grid")[0].p.colModel.length) {#}
        {#              p.columns.push({#}
        {#                name: 'All',#}
        {#                label: 'Any Field',#}
        {#                searchoptions: {},#}
        {#                searchrules: {},#}
        {#                searchtype: 'string',#}
        {#                inputtype: 'text'#}
        {#              });#}
        {#            }#}
        {#            //$(this).find('.delete-rule:first').hide();#}
        {#          }#}
        {#        }#}
      );

      // CSV Export footer button
      $dcGrid.jqGrid('navButtonAdd','#navGridMetadata',{
        id:'ExportToExcel',
        caption:'Export Selected Rows To CSV',
        title:'Export Selected Rows To CSV',
        onClickButton : function(e)
        {
          exportData(e, '#gridMetadata');
        },
        buttonicon: 'ui-icon ui-icon-document'
      });

      {#      // Column mover and chooser#}
      {#      $dcGrid.jqGrid('navButtonAdd', '#navGridMetadata', {#}
      {#        caption: "showcolumns",#}
      {#        buttonicon: "ui-icon-calculator",#}
      {#        title: "Choose columns",#}
      {#        onClickButton: function () {#}
      {#          $(this).jqGrid('columnChooser',{#}
      {#						width: 700,#}
      {#						dialog_opts: {#}
      {#							modal: true,#}
      {#							minWidth: 470,#}
      {#							height: 470,#}
      {#							show: 'blind',#}
      {#							hide: 'explode',#}
      {#							dividerLocation: 0.5#}
      {#						}#}
      {#          });#}
      {#          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.selected")#}
      {#            .bind("sortreceive", function (event, ui) {#}
      {#              alert('column "' + ui.item.text() + '" is chosen');#}
      {#            });#}
      {#          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.available a.action")#}
      {#            .click(function () {#}
      {#              alert('column "' + $(this).parent().text() + '" is chosen');#}
      {#            });#}
      {##}
      {#        }#}
      {#      });#}


      {#      setSearchSelect('assetInfo.array');#}
      {#      $dcGrid.jqGrid('setColProp', 'assetInfo.array',#}
      {#        {#}
      {#          searchoptions: {#}
      {#            sopt:['cn'],#}
      {#            dataInit: function(elem) {#}
      {#              $(elem).autocomplete({#}
      {#                source:getUniqueNames('assetInfo.array'),#}
      {#                delay:0,#}
      {#                minLength:0#}
      {#              });#}
      {#            }#}
      {#          }#}
      {#        }#}
      {#      );#}

      $dcGrid.jqGrid('filterToolbar',
        {
          autosearch : true,
          searchOperators : false,
          searchOnEnter : false,
          stringResult : true,
          defaultSearch : "cn"
        }
      );

      {#      if(location.hash!=""){#}
      {#        setScienceFilter('ref_des', location.hash.split('#')[1]);#}
      {#      }#}
    } // placeJqGrid Metadata

    var deploymentCollection;
    var integrationCollection;
    var tagCollection;
    var calibrationCollection;


    var getEventData = function(rowData) {
{#      console.log('rowData');#}
{#      console.log(rowData);#}
{#      console.log('rowData.eventId');#}
{#      console.log(rowData.eventId);#}

      var output = {};
      var eventCollection = new AssetEventsCollection({id: parseInt(currentAssetId)});
      var eventsFetch = eventCollection.fetch();
      $.when(eventsFetch).done(function() {
{#        console.log('eventCollection');#}
{#        console.log(eventCollection);#}
        if(rowData.eventClass == '.DeploymentEvent'){
          output = eventCollection.where({'eventClass': '.DeploymentEvent'})[0];
{#          console.log('output.attributes');#}
{#          console.log(output.attributes);#}
          {#          return output;#}
          deploymentCollection = output.attributes;
          {#          $gridEvents.setGridParam({data:output.attributes});#}
          {#          $gridEvents.trigger("reloadGrid",[{page:1,current:true}]);#}
        }
      });

    };


    var subNames = [];
    var subColumns = [];
    var subModel = {};
    var subData = {};

    function placeJqGridEvents(collection) {
      {#      console.log(collection);#}
      $gridEvents.jqGrid({
        datatype : "local",
        data : collection,
        editurl : "/api/asset_deployment/ajax",
        colNames: [
          'Event ID',
          'Start Date',
          'End Date',
          'Tense',
          'Event Class',
          'Coordinates',
          'Notes'
        ],

        colModel : [
          {
            name : 'eventId',
            key : true,
            index : 'eventId',
            editable : false,
            {#                      width : 100,#}
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'startDate',
            index : 'startDate',
            editable : false,
            {#                      width : 100,#}
            sortable : true,
            sorttype : 'date',
            formatter: unixTimeToDateTime,
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'endDate',
            index : 'endDate',
            editable : false,
            {#                      width : 100,#}
            sortable : true,
            sorttype : 'date',
            formatter: unixTimeToDateTime,
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'tense',
            index : 'tense',
            editable : false,
            {#                      width : 100,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'eventClass',
            index : 'eventClass',
            editable : false,
            hidden : false,
            {#                      width : 100,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'locationLonLat',
            index : 'locationLonLat',
            editable : false,
            {#                      width : 100,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'notes',
            index : 'notes',
            editable : false,
            hidden : false,
            {#                      width : 100,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          }
        ],
        {#        ondblClickRow: function (id) { alert("You double click row with id: " + id); },#}
        loadComplete : function(data) {
          $("#navGridEvents").find("option[value=\"50000\"]").text('All');
        },
        onSelectRow: function (rowId, status, e) {
          {#          console.log(collection.where({id:parseInt(rowId)})[0]);#}
          {#          setEventFilter("","");#}
          {#          $gridMetadata.jqGrid('resetSelection');#}
          {#          $gridEvents.jqGrid('resetSelection');#}
          {#          var metadataObjects = collection.where({id:parseInt(rowId)})[0].attributes.metaData;#}
          {#          $gridMetadata.setGridParam({data:metadataObjects});#}
          {#          $gridMetadata.trigger("reloadGrid",[{page:1,current:true}]);#}
          {##}
          {#          var eventObjects = collection.where({id:parseInt(rowId)})[0].attributes.events;#}
          {#          $gridEvents.setGridParam({data:eventObjects});#}
          {#          $gridEvents.trigger("reloadGrid",[{page:1,current:true}]);#}
          {##}
          {#          renderRemoteDocuments(collection.where({id:parseInt(rowId)})[0]);#}

          {#          getEventData(rowId);#}
        },
        serializeRowData: function(postdata){
          {#          console.log(postdata);#}
          return JSON.stringify(postdata);
        },
        gridview : true,
        rowNum : 15,
        rowList : [15, 30, 45, 60, 50000],
        autowidth : true,
        height : 'auto',
        pager : '#navGridEvents',
        sortname : 'end',
        viewrecords : true,
        sortorder : 'desc',
        caption : 'Events',
        altRows: false,
        {#        altclass:'myAltRowClass',#}
        {#        classes: 'table table-bordered table-striped table-selectable',#}
        ignoreCase: true,
        shrinkToFit : false,
        multiselect: true,
        multiboxonly: true,
        reloadAfterSubmit : false,
        loadOnce : false,
        subGrid : true,
        subGridOptions: {
          "plusicon": "ui-icon-triangle-1-e",
          "minusicon": "ui-icon-triangle-1-s",
          "openicon": "ui-icon-arrowreturn-1-e",
          "reloadOnExpand": true,
          "selectOnExpand": true
        },
        subGridBeforeExpand: function(subgrid_id, row_id) {
          subNames = [];
          subColumns = [];
          subModel = {};
          subData = {};
{#          console.log('expanded row');#}
{#          console.log(row_id);#}
          var selectedRow = $gridEvents.getRowData(row_id);
{#          console.log(selectedRow);#}
{#          console.log('selectedRow.eventId');#}
{#          console.log(selectedRow.eventId);#}

          var selectedAssetRow = $dcGrid.getRowData(currentAssetId);
{#          console.log('selectedAssetRow');#}
{#          console.log(selectedAssetRow);#}

          {#          console.log('expanded row');#}
          {#          console.log(row_id);#}
          {#          var selectedRow = $gridEvents.getRowData(row_id);#}
          {#          console.log(selectedRow);#}
          {#          console.log('selectedRow.eventId');#}
          {#          console.log(selectedRow.eventId);#}

          var eventCollection = new AssetEventsCollection({id: parseInt(currentAssetId)});
          var eventsFetch = eventCollection.fetch();
          $.when(eventsFetch).done(function() {

{#            console.log('eventCollection');#}
{#            console.log(eventCollection);#}

            var output = {};
            // .DeploymentEvent
            {#            if(selectedRow.eventClass == '.DeploymentEvent'){#}
            {#              output = eventCollection.where({'eventClass': '.DeploymentEvent'})[0];#}
            output = eventCollection.where({'eventClass': selectedRow.eventClass})[0];
{#            console.log('output.attributes');#}
{#            console.log(output.attributes);#}
            {#          return output;#}
            deploymentCollection = output.attributes;
            {#          $gridEvents.setGridParam({data:output.attributes});#}
            {#          $gridEvents.trigger("reloadGrid",[{page:1,current:true}]);#}
{#            console.log('deploymentCollection');#}
{#            console.log(deploymentCollection);#}

            var subgridData;

            if(selectedRow.eventClass == '.DeploymentEvent') {
              subgridData = deploymentCollection;
              subNames = [
                "deploymentShipName",
                "deploymentNumber",
                "cruise",
                "cruiseNumber",
                "cruisePlanDocument.url",
                "notes",
                "locationLonLat",
                "recoveryShipName",
                "recoveryPlanDocument.url",
                "recoveryCruiseNumber",
                "recoveryLocationLonLat"
              ];
              subColumns = [
                "Ship Name (D)",
                "Deployment #",
                "Cruise (D)",
                "Cruise # (D)",
                "Cruise Doc (D)",
                "Notes (D)",
                "Coordinates (D)",
                "Ship Name (R)",
                "Plan Doc (R)",
                "Cruise # (R)",
                "Coordinates (R)"
              ];

              // Put the data in the subgrid
              mysubdata = [];
              mysubdata[0] = {};
              for (var j = 0; j < subNames.length; j++) {
                mysubdata[0][subNames[j]] = subgridData[subNames[j]];
              }
{#              console.log('mysubdata');#}
{#              console.log(mysubdata);#}
              subData = mysubdata;

            } else if(selectedRow.eventClass == '.TagEvent') {
{#              console.log('.tagEvent');#}
{#              console.log('.IntegrationEvent');#}
              subgridData = deploymentCollection;
{#              console.log(subgridData);#}
              subNames = [];
              subColumns = [];

              subNames = Object.keys(subgridData);
              subColumns = subNames;

              // Put the data in the subgrid
              mysubdata = [];
              mysubdata[0] = {};
              for (var j = 0; j < subNames.length; j++) {
                if(!typeof subgridData[subNames[j]] == "object") {
                  mysubdata[0][subNames[j]] = subgridData[subNames[j]];
                } else {
                  subNames.splice(subNames.indexOf(subNames[j]), 1);
                }
              }

              $.each (subNames, function() {
                mysubdata[0][this] = subgridData[this];
              });
              subColumns = subNames;
{#              console.log(subNames);#}
{#              console.log(subColumns);#}
{#              console.log('mysubdata');#}
{#              console.log(mysubdata);#}
              subData = mysubdata;
            } else if(selectedRow.eventClass == '.IntegrationEvent') {
{#              console.log('.IntegrationEvent');#}
              subgridData = deploymentCollection;
{#              console.log(subgridData);#}
              subNames = [];
              subColumns = [];

              subNames = Object.keys(subgridData);
              subColumns = subNames;

              // Put the data in the subgrid
              mysubdata = [];
              mysubdata[0] = {};
              for (var j = 0; j < subNames.length; j++) {
                if(!typeof subgridData[subNames[j]] == "object") {
                  mysubdata[0][subNames[j]] = subgridData[subNames[j]];
                } else {
                  subNames.splice(subNames.indexOf(subNames[j]), 1);
                }
              }

              $.each (subNames, function() {
                mysubdata[0][this] = subgridData[this];
              });
              subColumns = subNames;
{#              console.log(subNames);#}
{#              console.log(subColumns);#}
{#              console.log('mysubdata');#}
{#              console.log(mysubdata);#}
              subData = mysubdata;

            } else if(selectedRow.eventClass == '.CalibrationEvent') {
              subgridData = deploymentCollection.calibrationCoefficient;
{#              console.log('.CalibrationEvent');#}
{#              console.log(subgridData);#}
              subNames = [];
              subColumns = [];
              $.each (subgridData, function() {
                subNames.push(this.name);
                subColumns.push(this.name);
              });

              // Put the data in the subgrid
              mysubdata = [];
              mysubdata[0] = {};
              for (var j = 0; j < subNames.length; j++) {
                mysubdata[0][subNames[j]] = subgridData[j].values;
              }
{#              console.log('mysubdata');#}
{#              console.log(mysubdata);#}
              subData = mysubdata;

            } else {
              subNames = [];
              subColumns = [];
            }


// Create the colModel
            subModel = [];
            for (var sn = 0; sn < subNames.length; sn++) {
              subModel.push({name:subNames[sn],index:subNames[sn]})
            }

            var subgrid_table_id;
            subgrid_table_id = subgrid_id + "_t";

            jQuery("#"+subgrid_id).html("<table id='"+subgrid_table_id+"' class='scroll'></table>");
            jQuery("#"+subgrid_table_id).jqGrid({
              datatype: "local",
              colNames: subColumns,
              colModel: subModel,
              {#                [#}
              {#                {name:"cruise",index:"cruise",width:80,key:false},#}
              {#                {name:"cruiseNumber",index:"cruiseNumber",width:130}#}
              {#              ],#}
              height: '100%',
              rowNum:10,
              sortname: 'cruise',
              sortorder: "asc"
            });

            $("#" + subgrid_table_id).jqGrid('addRowData', 1, subData[0]);

          });


        },
        subGridRowExpanded: function(subgrid_id, row_id) {




        }

      }).jqGrid('navGrid',
        '#navGridEvents',
        {add:false, view:false, del:false,edit:false,pdf:true}
        {#        ,{closeOnEscape: true, afterSubmit: fn_editSubmit}#}
        {#        ,{closeOnEscape: true, afterSubmit: fn_editSubmit} /*add options*/#}
        ,{} /*delete options*/
        {#        ,{multipleSearch:true}#}
        {#        ,{closeOnEscape:true}#}
        {#        {#}
        {#          edit : true,#}
        {#          add : true,#}
        {#          del : false,#}
        {##}
        {#          // beforeRefresh:#}
        {#          // Set the latest data from collection before refreshing grid#}
        {#            beforeRefresh : function () {#}
        {#              $("#grid").jqGrid('setGridParam', {#}
        {#                datatype : 'local',#}
        {#                data : ooi.collections.streams.toJSON()#}
        {#              });#}
        {#            }#}
        {#        },#}
        {#        {serializeEditData: function (postdata) {return JSON.stringify(postdata)}},#}
        {#        {serializeEditData: function (postdata) {return JSON.stringify(postdata)}},#}
        {#        {},#}
        {#        {#}
        {#          cloneToTop : true,#}
        {#          closeOnEscape : true,#}
        {#          multipleSearch : true,#}
        {#          overlay: 0,#}
        {#          onInitializeSearch: function ($form) {#}
        {#            $form.jqFilter('addFilter', defaultFilters);#}
        {#          },#}
        {#          afterRedraw: function (p) {#}
        {#            if (p.columns.length === $("#grid")[0].p.colModel.length) {#}
        {#              p.columns.push({#}
        {#                name: 'All',#}
        {#                label: 'Any Field',#}
        {#                searchoptions: {},#}
        {#                searchrules: {},#}
        {#                searchtype: 'string',#}
        {#                inputtype: 'text'#}
        {#              });#}
        {#            }#}
        {#            //$(this).find('.delete-rule:first').hide();#}
        {#          }#}
        {#        }#}
      );

      // CSV Export footer button
      $dcGrid.jqGrid('navButtonAdd','#navGridEvents',{
        id:'ExportToExcel',
        caption:'Export Selected Rows To CSV',
        title:'Export Selected Rows To CSV',
        onClickButton : function(e)
        {
          exportData(e, '#gridEvents');
        },
        buttonicon: 'ui-icon ui-icon-document'
      });

      {#      // Column mover and chooser#}
      {#      $dcGrid.jqGrid('navButtonAdd', '#navGridMetadata', {#}
      {#        caption: "showcolumns",#}
      {#        buttonicon: "ui-icon-calculator",#}
      {#        title: "Choose columns",#}
      {#        onClickButton: function () {#}
      {#          $(this).jqGrid('columnChooser',{#}
      {#						width: 700,#}
      {#						dialog_opts: {#}
      {#							modal: true,#}
      {#							minWidth: 470,#}
      {#							height: 470,#}
      {#							show: 'blind',#}
      {#							hide: 'explode',#}
      {#							dividerLocation: 0.5#}
      {#						}#}
      {#          });#}
      {#          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.selected")#}
      {#            .bind("sortreceive", function (event, ui) {#}
      {#              alert('column "' + ui.item.text() + '" is chosen');#}
      {#            });#}
      {#          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.available a.action")#}
      {#            .click(function () {#}
      {#              alert('column "' + $(this).parent().text() + '" is chosen');#}
      {#            });#}
      {##}
      {#        }#}
      {#      });#}


      {#      setSearchSelect('assetInfo.array');#}
      {#      $dcGrid.jqGrid('setColProp', 'assetInfo.array',#}
      {#        {#}
      {#          searchoptions: {#}
      {#            sopt:['cn'],#}
      {#            dataInit: function(elem) {#}
      {#              $(elem).autocomplete({#}
      {#                source:getUniqueNames('assetInfo.array'),#}
      {#                delay:0,#}
      {#                minLength:0#}
      {#              });#}
      {#            }#}
      {#          }#}
      {#        }#}
      {#      );#}

      $dcGrid.jqGrid('filterToolbar',
        {
          autosearch : true,
          searchOperators : false,
          searchOnEnter : false,
          stringResult : true,
          defaultSearch : "cn"
        }
      );

      {#      if(location.hash!=""){#}
      {#        setScienceFilter('ref_des', location.hash.split('#')[1]);#}
      {#      }#}
    } // placeJqGrid Events

    var showAssets = function(collection, response){
      //jqGrid
      var jqCollection = collection;
      jqCollection['actions'] = '';
      placeJqGrid(jqCollection);
      placeJqGridMetadata({});
      placeJqGridEvents({});
    };

    var renderRemoteDocuments = function(model) {
      //clear out the old events table panel DOM
      $('div#remoteDocuments table tbody').remove();

      var ref_des = model.get('ref_des');
      var cruise = null;
      var array = model.get('assetInfo').array;

      _.each( model.attributes.metaData, function(item){
        if (item.key == "Cruise Number"){
          cruise = item['value'];
        }
      });

      var data = { 'search': ref_des,'cruise': cruise,'array':array};

      var alfrescoDocCollection = new AlfrescoDocumentCollection();

      //create a new table body and render it's view
      alfrescoDocCollection.fetch({
        data: data,
        success: function() {
          $('div#remoteDocuments table tbody').remove();
          $('div#remoteDocuments table #loadDocs').remove();
          var alfrescoTableBodyView = new AlfrescoTableBodyView({ collection:alfrescoDocCollection });
          alfrescoTableBodyView.renderRecords();

          // append to the DOM
          $('div#remoteDocuments table').append( alfrescoTableBodyView.el );
        },
        error: function(e) {
          $('div#remoteDocuments table tbody').remove();
          $('div#remoteDocuments table #loadDocs').remove();
          $('div#remoteDocuments table p').remove();
          $('div#remoteDocuments table').append('<p>Could not find any associated documents.</p>');
        }
      });
    };

    var populate = function() {
      updateCollection( showAssets );
    };

    var updateCollection = function(successCallback){
      collection.fetch({
        success : successCallback
      });
    };

    var unixTimeToDateTime = function(cellvalue) {
      var newDate = new Date(cellvalue);
      return newDate;
    };

    var isoToDateTime = function(cellvalue) {
      var temp = (String(cellvalue).search('Z') > 1) ? String(cellvalue).split('Z') : false;
      var returnDate = (true) ? new Date(Date.parse(temp[0])) : new Date(temp);
      return returnDate;
    };

    var dateTimeToISO = function(strInput) {
      var temp = Date.parse(strInput);
      var parseDate = new Date(temp);
      var isoDateReturn = parseDate.toISOString();
      return isoDateReturn;
    };

    var documentDef = function(obj) {
      var planDoc = [];
      if (obj) {
        planDoc = [
          'Data Source: ' + obj.dataSource,
          'Label: ' + obj.label,
          'Remote Resource ID: ' + obj.remoteResourceId,
          'Resource Number: ' + obj.resourceNumber];
      } else {
        planDoc = ["Plan not provided"];
      }
      return planDoc;
    };
  </script>
{% endblock %}
